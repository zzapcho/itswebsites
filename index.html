<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¬¸ì¥ ì‹¤í—˜ì‹¤: ì•…ë§ˆÂ·ë§ˆë²•Â·ì§€ë ì´ + ëª¨ë“  ì£¼ì œ</title>
  <style>
    :root{
      --bg:#050508;
      --fg:#ececf4;
      --muted:#9a9ab0;
      --line:#232332;
      --card:#0c0c13cc;
      --glow: 0 0 40px rgba(255,255,255,.06);
      --shadow: 0 18px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--fg);
      background:
        radial-gradient(950px 650px at 14% 22%, rgba(90,40,120,.28) 0%, transparent 55%),
        radial-gradient(950px 650px at 84% 76%, rgba(170,45,70,.23) 0%, transparent 58%),
        radial-gradient(900px 520px at 50% 110%, rgba(20,120,90,.18) 0%, transparent 60%),
        linear-gradient(180deg, #0a0a12, var(--bg));
      overflow:hidden;
      font-family: system-ui, -apple-system, "Pretendard", Segoe UI, Roboto, sans-serif;
      display:flex; align-items:center; justify-content:center;
    }

    .sway{ animation: sway 6.8s ease-in-out infinite; transform-origin: 50% 55%; }
    @keyframes sway{
      0%{transform: rotate(0deg) translateY(0px)}
      30%{transform: rotate(0.18deg) translateY(-2px)}
      65%{transform: rotate(-0.16deg) translateY(1px)}
      100%{transform: rotate(0deg) translateY(0px)}
    }

    .grain{
      position:fixed; inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.95' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.28'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.075;
    }

    .float{ position:fixed; inset:-20vh -20vw; pointer-events:none; z-index:1; opacity:.22; }
    .float span{
      position:absolute; white-space:nowrap; user-select:none;
      font-size: 13px; letter-spacing:.14em;
      color:#c7c7d6;
      opacity:.55;
      animation: drift linear infinite;
      filter: blur(.15px);
    }
    @keyframes drift{
      from{ transform: translate3d(var(--x0), var(--y0), 0) }
      to  { transform: translate3d(var(--x1), var(--y1), 0) }
    }

    .wrap{
      width:min(1040px, 92vw);
      padding:24px;
      position:relative;
      z-index:2;
    }

    .top{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:14px; margin-bottom:14px;
    }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .title{
      font-size:12px; letter-spacing:.22em; text-transform:uppercase;
      color:var(--muted);
    }
    .subtitle{
      font-size:14px; color:#cfcfe0; opacity:.9;
    }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      border:1px solid var(--line);
      background:#0b0b13aa;
      padding:9px 10px;
      border-radius:999px;
      font-size:12px;
      color:#d9d9e7;
      box-shadow: var(--glow);
      user-select:none;
    }

    .card{
      border:1px solid var(--line);
      background:var(--card);
      backdrop-filter: blur(10px);
      border-radius:20px;
      padding:20px;
      box-shadow: var(--shadow);
    }

    .sentence{
      font-size: clamp(20px, 2.7vw, 40px);
      line-height:1.36;
      letter-spacing:-0.02em;
      white-space:pre-wrap;
      word-break:keep-all;
      opacity:0;
      transform: translateY(10px);
      filter: blur(.25px);
      transition: opacity .38s ease, transform .38s ease, filter .38s ease;
      cursor:pointer;
      user-select:none;
    }
    .sentence.show{
      opacity:1;
      transform: translateY(0);
      filter: blur(0);
    }

    .meta{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      flex-wrap:wrap;
    }

    .hud{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap:14px;
    }
    @media (max-width: 820px){
      .hud{ grid-template-columns: 1fr; }
    }
    .panel{
      border:1px solid var(--line);
      background:#090910a8;
      border-radius:16px;
      padding:14px 14px 12px;
      box-shadow: var(--glow);
    }
    .panel h3{
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:#bdbdd0;
      font-weight:650;
    }

    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    select{
      border:1px solid var(--line);
      background:#0a0a12;
      color:var(--fg);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      outline:none;
      box-shadow: var(--glow);
      max-width:100%;
    }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:1px solid var(--line);
      background:#0a0a12;
      color:var(--fg);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:13px;
      box-shadow: var(--glow);
    }
    button:hover{ filter:brightness(1.14); }
    button:active{ transform: translateY(1px); }

    .tiny{
      margin-top:10px;
      font-size:12px;
      color:#a8a8be;
      line-height:1.55;
      opacity:.95;
    }
    kbd{
      border:1px solid var(--line);
      border-bottom-width:2px;
      padding:2px 6px;
      border-radius:7px;
      font-size:11px;
      background:#0a0a12;
      color:#e6e6f2;
    }

    .bars{ display:flex; flex-direction:column; gap:10px; }
    .barrow{ display:grid; grid-template-columns: 92px 1fr 44px; gap:10px; align-items:center; }
    .label{ font-size:12px; color:#d9d9e7; opacity:.95; }
    .track{ height:10px; border-radius:999px; border:1px solid var(--line); background:#07070d; overflow:hidden; }
    .fill{ height:100%; width:0%; border-radius:999px; background: linear-gradient(90deg, rgba(255,255,255,.10), rgba(255,255,255,.22)); transition: width .45s ease; }
    .pct{ font-size:12px; color:#bdbdd0; text-align:right; }

    .toast{
      position:fixed;
      left:50%;
      bottom:20px;
      transform:translateX(-50%);
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#0b0b13cc;
      backdrop-filter: blur(10px);
      box-shadow: var(--glow);
      color:var(--fg);
      font-size:13px;
      opacity:0;
      transition: opacity .18s ease;
      z-index:9999;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <div class="grain"></div>
  <div class="float" id="float"></div>
  <div class="toast" id="toast"></div>

  <div class="wrap sway">
    <div class="top">
      <div class="brand">
        <div class="title">sentence lab v2</div>
        <div class="subtitle">ì£¼ì œ 12ê°œ Â· íŒ¨í„´ 40+ Â· ë‹¨ì–´ í’€ í™•ì¥ Â· í´ë¦­í• ìˆ˜ë¡ ë„ˆ ì·¨í–¥ìœ¼ë¡œ í¸í–¥</div>
      </div>
      <div class="chips">
        <div class="chip" id="topicChip">TOPIC: AUTO</div>
        <div class="chip" id="moodChip">MOOD: ???</div>
        <div class="chip" id="countChip">#000</div>
      </div>
    </div>

    <div class="card">
      <div id="sentence" class="sentence" title="í´ë¦­í•˜ë©´ ë‹¤ìŒ ë¬¸ì¥"></div>
      <div class="meta">
        <div>
          í´ë¦­/ìŠ¤í˜ì´ìŠ¤/ì—”í„°: ë‹¤ìŒ Â· <kbd>C</kbd> ë³µì‚¬ Â· <kbd>A</kbd> ì¶”ê°€ Â· <kbd>T</kbd> ì£¼ì œ AUTO Â· <kbd>R</kbd> ë¦¬ì…‹
        </div>
        <div id="seedInfo">bias: -</div>
      </div>

      <div class="hud">
        <div class="panel">
          <h3>topic + world bias</h3>
          <div class="row">
            <select id="topicSelect" title="ì£¼ì œ ì„ íƒ">
              <option value="AUTO">AUTO (ì•Œì•„ì„œ ì„ê¸°)</option>
            </select>
            <button id="btnAuto">AUTOë¡œ</button>
            <button id="btnShuffle">ì£¼ì œ ì„ê¸°</button>
          </div>

          <div class="tiny">AUTOëŠ” ë„¤ê°€ ë§ì´ ë³¸ ì£¼ì œë¡œ ìë™ í¸í–¥ë¨. ìˆ˜ë™ ì„ íƒí•˜ë©´ ê·¸ ì£¼ì œ ìœ„ì£¼ë¡œ ë‚˜ì˜´.</div>

          <div style="height:12px"></div>

          <div class="bars">
            <div class="barrow">
              <div class="label">ì•…ë§ˆ/ì–´ë‘ </div>
              <div class="track"><div class="fill" id="barDevil"></div></div>
              <div class="pct" id="pctDevil">0%</div>
            </div>
            <div class="barrow">
              <div class="label">ë§ˆë²•/ì´ˆí˜„ì‹¤</div>
              <div class="track"><div class="fill" id="barMagic"></div></div>
              <div class="pct" id="pctMagic">0%</div>
            </div>
            <div class="barrow">
              <div class="label">ì§€ë ì´/í™</div>
              <div class="track"><div class="fill" id="barWorm"></div></div>
              <div class="pct" id="pctWorm">0%</div>
            </div>
          </div>

          <div class="tiny">
            í•™ìŠµì€ ë¡œì»¬ ì €ì¥(ë¸Œë¼ìš°ì €). ë§ì´ ëˆŒëŸ¬ë³¼ìˆ˜ë¡ â€œë„ˆ ìŠ¤íƒ€ì¼ ì´ìƒë¬¸ì¥â€ì´ ë¨.
          </div>
        </div>

        <div class="panel">
          <h3>actions</h3>
          <div class="btns">
            <button id="btnNext">ë‹¤ìŒ(Enter)</button>
            <button id="btnCopy">ë³µì‚¬(C)</button>
            <button id="btnAdd">ë‚´ ë¬¸ì¥ ì¶”ê°€(A)</button>
            <button id="btnReset">ë¦¬ì…‹(R)</button>
          </div>
          <div class="tiny">
            ë‹¨ì¶•í‚¤: <kbd>Space</kbd>/<kbd>Enter</kbd> ë‹¤ìŒ Â· <kbd>C</kbd> ë³µì‚¬ Â· <kbd>A</kbd> ì¶”ê°€ Â· <kbd>T</kbd> AUTO Â· <kbd>R</kbd> ë¦¬ì…‹<br>
            â€œì£¼ì œ ì„ê¸°â€ëŠ” ìˆ˜ë™ ì£¼ì œì—ì„œë„ ëœë¤í•˜ê²Œ ì¼ë¶€ ì„ì´ê²Œ ë§Œë“œëŠ” ìŠ¤ìœ„ì¹˜ì„.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------------------------
  // ì €ì¥/ë¡œë“œ
  // ---------------------------
  const KEY = {
    lines: "labv2_lines",
    clicks: "labv2_clicks",
    bias: "labv2_bias",
    topicBias: "labv2_topic_bias",
    topic: "labv2_topic",
    mix: "labv2_mix"
  };

  function load(k, fallback){
    try{
      const v = localStorage.getItem(k);
      return v ? JSON.parse(v) : fallback;
    }catch{ return fallback; }
  }
  function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

  // ---------------------------
  // ìœ í‹¸
  // ---------------------------
  const rnd = (n)=> Math.floor(Math.random()*n);
  function pick(arr){ return arr[rnd(arr.length)]; }
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

  function weightedPick(options){
    const sum = options.reduce((a,o)=>a+o.weight,0);
    let r = Math.random()*sum;
    for(const o of options){
      r -= o.weight;
      if(r <= 0) return o.value;
    }
    return options[options.length-1].value;
  }

  function format(t, map){
    return t.replace(/\{(\w+)\}/g, (_,k)=> map[k] ?? `{${k}}`);
  }

  // ---------------------------
  // í† ìŠ¤íŠ¸
  // ---------------------------
  const elToast = document.getElementById("toast");
  function toast(msg){
    elToast.textContent = msg;
    elToast.style.opacity = "1";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> elToast.style.opacity="0", 900);
  }

  // ---------------------------
  // ì£¼ì œ(12ê°œ)
  // ---------------------------
  const TOPICS = {
    "DEVIL": "ì•…ë§ˆ/ì–´ë‘ ",
    "MAGIC": "ë§ˆë²•/ì´ˆí˜„ì‹¤",
    "WORM": "ì§€ë ì´/í™",
    "NIGHT": "ìƒˆë²½/ëª½ë¡±",
    "SCHOOL": "í•™êµ/ìˆ˜ì—…",
    "TECH": "ê¸°ìˆ /ë²„ê·¸",
    "GAME": "ê²Œì„/ë­í¬",
    "FRIEND": "ì¹œêµ¬/ëŒ€í™”",
    "FEEL": "ê°ì •/ìê¸°ê³ ë°±",
    "COSMOS": "ìš°ì£¼/ì² í•™",
    "CITY": "ë„ì‹œ/ì‚¬ëŒë“¤",
    "META": "ë©”íƒ€/ìê¸°ì°¸ì¡°"
  };

  // ---------------------------
  // ë‹¨ì–´ í’€(ì¹´í…Œê³ ë¦¬ë³„ â€œì—„ì²­ ë‹¤ì–‘í•˜ê²Œâ€)
  // ---------------------------
  const LEX = {
    opener: ["ì‘","ì•„ë‹ˆ","ì–´..","ì–´....","ã…‡ã…‹","ã…‡ã…‡","ì ê¹","ê·¸ë˜","ëª°ë¼","ë§ì•„","ì¸ì •","ë¶€ì •","ã„´ã„´","ã…‡ã…‡ã…‹","í ","ì•„ì‡","ì§„ì§œ","ê·¸ë§Œ","ê³„ì†","í•œë²ˆë§Œ"],
    connector: ["ê·¼ë°","ê·¸ë˜ì„œ","ê·¸ëŸ¬ë‹ˆê¹Œ","ê²°êµ­","ì•„ë¬´íŠ¼","í•œí¸","ê·¸ëŸ°ë°ë„","ëŒ€ì‹ ","ì˜¤íˆë ¤","ê²Œë‹¤ê°€","ê·¸ ì™€ì¤‘ì—","ë¬¸ì œëŠ”","ê²°ë¡ ì€"],
    time: ["ì§€ê¸ˆ","ë°©ê¸ˆ","ì–´ì œ","ì˜¤ëŠ˜","ë‚´ì¼","ìƒˆë²½","ë°¤","í•œë‚®","ìˆ˜ì—…ì‹œê°„","ì‰¬ëŠ”ì‹œê°„","ì§‘ ê°€ëŠ” ê¸¸","ë¶ˆ êº¼ì§„ ë°©","ë¡œê·¸ì•„ì›ƒ ì§ì „"],
    subject: ["ë‹¹ê·¼","ì²œì¥","ë°”ë‹¥","ê±°ìš¸","ë¬¸ê³ ë¦¬","ê°€ë¡œë“±","ì¹¨ëŒ€","ì±…ìƒ","ë³µë„","êµì‹¤","ìš´ë™ì¥","ì´ì–´í°","ë§ˆìš°ìŠ¤","í‚¤ë³´ë“œ","ë°°í„°ë¦¬","ì„œë²„","ì°½ë¬¸","ë…¸íŠ¸","ì†ë“±","ì‹¬ì¥","ëª©","ëˆˆêº¼í’€","ìˆ¨","ì•Œë¦¼","ì§„ë™"],
    person: ["ë‚˜","ë„ˆ","ìš°ë¦¬","ê·¸ ì‚¬ëŒ","ì„ ìƒë‹˜","ì¹œêµ¬","ëª¨ë¥´ëŠ” ì‚¬ëŒ","ë¯¸ë˜ì˜ ë‚˜","ê³¼ê±°ì˜ ë‚˜","ë‚¯ì„  ëª©ì†Œë¦¬","ì±„íŒ…ì°½","ìµëª…","ê´€ì „ì","ì œ3ì","ë‚´ ì•ˆì˜ ë‚˜"],
    creature: ["ì•…ë§ˆ","ì²œì‚¬","ë§ˆë²•ì‚¬","ì§€ë ì´","ê³ ì–‘ì´","ê¹Œë§ˆê·€","ê·¸ë¦¼ì","ë§ë ¹","ìš”ì •","ë²„ê·¸","ì•Œê³ ë¦¬ì¦˜","ê²€ì€ ì ","í•˜ì–€ ì†ŒìŒ","ì´ëª¨ì§€","ì•„ì´ì½˜","NPC","ë³´ìŠ¤","ë¯¸ë‹ˆì–¸","ê³µí—ˆ"],
    magic: ["ë§ˆë²•","ì£¼ë¬¸","ì €ì£¼","ë£¬","ê¸°ì ","í™˜ê°","í˜„ì‹¤","ê¿ˆ","ë”œë ˆì´","ë™ê¸°í™”","ë¦¬ì…‹","íŒ¨ì¹˜","ë²„ì „ì—…","ë°±ì—…","ë³µì›","í¬íƒˆ","ê²°ê³„","ë²„í”„","ë””ë²„í”„"],
    emotion: ["í—ˆë¬´","ì§œì¦","ê¸°ì¨","ë¶ˆì•ˆ","ì•ˆë„","ì“¸ì“¸í•¨","ì„¤ë ˜","ë©í•¨","ë¶„ë…¸","ë¬´ê¸°ë ¥","ìš©ê¸°","í¬ê¸°","ì§‘ì°©","í‰ì˜¨","í˜¼ë€","ë°”ì¨","í”¼ë¡œ","ì§„ì •","ë¯¸ë¬˜í•¨"],
    action: ["ì†ì‚­ì˜€ë‹¤","ì›ƒì—ˆë‹¤","ì‚¬ë¼ì¡Œë‹¤","ë‚¨ì•„ìˆì—ˆë‹¤","ë¶€ì„œì¡Œë‹¤","ë¶™ì–´ë²„ë ¸ë‹¤","í˜ëŸ¬ê°”ë‹¤","ë°”ë€Œì—ˆë‹¤","ë’¤ì§‘í˜”ë‹¤","ì ë“¤ì—ˆë‹¤","ê¹¨ë‹¬ì•˜ë‹¤","ê±°ì§“ë§í–ˆë‹¤","ì‚¬ê³¼í–ˆë‹¤","ë„ë§ì³¤ë‹¤","ë¡œê·¸ë¥¼ ë‚¨ê²¼ë‹¤","ëˆˆì„ ê°ì•˜ë‹¤","ëˆˆì¹˜ë¥¼ ë´¤ë‹¤","ëŒ€ë‹µì„ ì‚¼ì¼°ë‹¤","í˜„íƒ€ë¥¼ ë§ì•˜ë‹¤"],
    tech: ["ì˜¤ë¥˜","ë²„ê·¸","ë¡œë”©","í¬ë˜ì‹œ","ê¶Œí•œ","ë¡œê·¸","ì„œë²„","í¬íŠ¸","í”„ë¡ì‹œ","ìºì‹œ","ì¿ í‚¤","ì„¸ì…˜","ë„ë©”ì¸","ë°©í™”ë²½","ì¬ì‹œì‘","ë¹Œë“œ","ë°°í¬","ë ˆí¬","ì»¤ë°‹","íŒ¨í‚·","í•‘","ì§€ì—°","ì—…íƒ€ì„","ë‹¤ìš´íƒ€ì„"],
    school: ["ìˆ˜ì—…","ìˆ™ì œ","ì‹œí—˜","ìˆ˜í–‰í‰ê°€","ê¸‰ì‹","ì¢…ë¡€","ììŠµ","ì¶œì„","ì¹ íŒ","êµê³¼ì„œ","í•„ê¸°","ë°œí‘œ","íŒ€í”Œ","êµë¬´ì‹¤","ë³µë„","ì‰¬ëŠ”ì‹œê°„"],
    game: ["ë­í¬","í","ë§¤ì¹˜","í‚¬","ë°ìŠ¤","ì–´ì‹œ","ê¶","ì—ì„","í—¤ë“œìƒ·","í•‘","ë ‰","í‹°ì–´","ë©˜íƒˆ","ìºë¦¬","íŠ¸ë¡¤","ì—°íŒ¨","ì—°ìŠ¹","ë§¤ì¹­","í”½","ë°´","ìŠ¤í‚¬","ì¿¨íƒ€ì„"],
    city: ["ì§€í•˜ì² ","ë²„ìŠ¤","íš¡ë‹¨ë³´ë„","í¸ì˜ì ","ê°€ë¡œë“±","ë¹„","ë°”ëŒ","ì‚¬ëŒë“¤","ì†ŒìŒ","ë„¤ì˜¨","ê³¨ëª©","ì—˜ë¦¬ë² ì´í„°","ì‹ í˜¸ë“±","ìš°ì‚°","ë°œìêµ­","ì°¨ ì†Œë¦¬"],
    cosmos: ["ìš°ì£¼","ë³„","ì¤‘ë ¥","ì‹œê°„","í‰í–‰ì„¸ê³„","ê°€ì„¤","í™•ë¥ ","ë¬´í•œ","ì—”íŠ¸ë¡œí”¼","ê´€ì¸¡","ê³µí—ˆ","ë¹›","ì•”í‘","ê¶¤ë„","ì‹ í˜¸","ì¢Œí‘œ"],
    meta: ["ì´ ë¬¸ì¥","ì´ í˜ì´ì§€","ì´ í´ë¦­","ì´ ì£¼ì œ","ì´ ì„¸ê³„ê´€","ë‚´ ë‡Œ","ë„ˆì˜ ëˆˆ","ì €ì¥ì†Œ","ìë™ì™„ì„±","ë§ë²„ë¦‡","íŒ¨í„´","í™•ë¥ ","ê°€ì¤‘ì¹˜","í•™ìŠµ","ë¡œì»¬ìŠ¤í† ë¦¬ì§€"]
  };

  // ---------------------------
  // ì£¼ì œë³„ â€œê°€ì¤‘ ë‹¨ì–´ ì„¸íŠ¸â€
  // ---------------------------
  const TOPIC_WORDS = {
    DEVIL: { agent:["ì•…ë§ˆ","ë§ë ¹","ê·¸ë¦¼ì","ìœ í˜¹","ì‹¬ì—°","ê²€ì€ ë†ë‹´","ê³µí—ˆ"], moodTag:"ğŸ˜ˆ" },
    MAGIC: { agent:["ë§ˆë²•","ì£¼ë¬¸","ë£¬","ê²°ê³„","í¬íƒˆ","ê¸°ì ","ì´ìƒí•œ ê·œì¹™"], moodTag:"ğŸª„" },
    WORM:  { agent:["ì§€ë ì´","í™","ë•…ì†","ë°”ë‹¥","ë¯¸ì„¸í•œ ìƒëª…","ì§„í™","ë¨¼ì§€"], moodTag:"ğŸª±" },
    NIGHT: { agent:["ìƒˆë²½","ì ","ëª½ë¡±","ì”ìƒ","ê°€ë¡œë“±","í•˜ì–€ ì†ŒìŒ","ëˆˆêº¼í’€"], moodTag:"ğŸŒ™" },
    SCHOOL:{ agent:["ìˆ˜ì—…","ìˆ™ì œ","ì¹ íŒ","êµì‹¤","ì¢…ë¡€","ìˆ˜í–‰í‰ê°€","í•„ê¸°"], moodTag:"ğŸ«" },
    TECH:  { agent:["ë²„ê·¸","ë¡œê·¸","ìºì‹œ","ì„œë²„","í¬íŠ¸","í”„ë¡ì‹œ","ê¶Œí•œ"], moodTag:"ğŸ§©" },
    GAME:  { agent:["ë­í¬","ë©˜íƒˆ","ì¿¨íƒ€ì„","í”½","ë°´","ì—°íŒ¨","ìºë¦¬"], moodTag:"ğŸ®" },
    FRIEND:{ agent:["ì¹œêµ¬","ì±„íŒ…","DM","ì½ì”¹","ëŒ€ë‹µ","ì´ëª¨ì§€","ë§íˆ¬"], moodTag:"ğŸ’¬" },
    FEEL:  { agent:["í—ˆë¬´","ë¶ˆì•ˆ","ì•ˆë„","ì“¸ì“¸í•¨","ì„¤ë ˜","ë¬´ê¸°ë ¥","í˜¼ë€"], moodTag:"ğŸ«§" },
    COSMOS:{ agent:["ìš°ì£¼","ë³„","í™•ë¥ ","ê´€ì¸¡","ê³µí—ˆ","ì‹œê°„","ì‹ í˜¸"], moodTag:"ğŸ›°ï¸" },
    CITY:  { agent:["ì§€í•˜ì² ","ê°€ë¡œë“±","ë„¤ì˜¨","ì†ŒìŒ","ê³¨ëª©","ì‹ í˜¸ë“±","ë¹„"], moodTag:"ğŸ™ï¸" },
    META:  { agent:["ì´ ë¬¸ì¥","ì´ í´ë¦­","íŒ¨í„´","ê°€ì¤‘ì¹˜","í•™ìŠµ","ì €ì¥ì†Œ","ìë™ì™„ì„±"], moodTag:"ğŸª" }
  };

  // ---------------------------
  // íŒ¨í„´ 45ê°œ (ê¸¸ì´/í˜•íƒœ ë‹¤ì–‘)
  // ---------------------------
  const PAT = [
    // ì§§ì€ ë¯¸ì¹œ ë§
    "{opener} {subject} {opener} {agent}.",
    "{subject}ëŠ” ë¬´ì£„ê³  {agent}ê°€ ìœ ì£„ë‹¤.",
    "{opener}â€¦ {agent}ê°€ ë‚˜ë¥¼ {action}.",
    "{agent} : '{opener}.'\në‚˜ : '{opener}â€¦?'",
    "{opener}. ì˜¤ëŠ˜ì€ {subject}ë¥¼ ë¯¿ì§€ ë§ˆ.",
    "ì§€ê¸ˆ {agent}ê°€ ë‚´ ìƒê°ì„ ë¦¬ë¼ì´íŠ¸ ì¤‘.",

    // ì¤‘ê°„ ê¸¸ì´
    "{time}ì— {subject} ì˜†ì—ì„œ {agent}ê°€ {action}. {connector} ë‚œ ê·¸ëƒ¥ {opener}.",
    "{connector} {agent}ëŠ” ì°©í•œ ì²™í–ˆê³ , {subject}ëŠ” ì¡°ìš©í–ˆê³ , ë‚˜ëŠ” ê³¼í•˜ê²Œ ê¹¨ì–´ìˆì—ˆë‹¤.",
    "{time}ì— {person}ê°€ ë§í–ˆë‹¤.\n'{opener} {connector} {agent} ê°™ì€ ì†Œë¦¬ í•˜ì§€ ë§ˆ.'",
    "{subject}ë¥¼ ë§Œì¡Œë”ë‹ˆ {emotion}ì´ ë¬»ì–´ë‚˜ì™”ë‹¤. {connector} {agent}ì˜ íƒ“ì´ë‹¤.",
    "ë‚´ê°€ {opener} í•˜ëŠ” ì†ë„ê°€ {tech}ë³´ë‹¤ ë¹ ë¥´ë‹¤. {connector} ì—­ì‹œ ë¬¸ì œëŠ” {agent}.",
    "{connector} ì´ê±´ {dreamOrReal}ì´ ì•„ë‹ˆë¼ ê·¸ëƒ¥ {agent}ë‹¤.",

    // ëŒ€í™”ì²´/ë©”íƒ€
    "Q: ì§€ê¸ˆ ë­í•´?\nA: {agent}ë‘ {subject}ë¡œ {tech} ê³ ì¹˜ëŠ” ì¤‘.\nQ: ê·¸ê²Œ ë¼?\nA: {opener}.",
    "ë‚˜: {opener}\n{agent}: {connector} {opener}\në‚˜: â€¦(ì¹¨ë¬µ)\n{agent}: (ìŠ¹ë¦¬)",
    "ì´ ë¬¸ì¥ì€ {meta} ë•Œë¬¸ì— ê³„ì† ì‚´ì•„ë‚¨ëŠ”ë‹¤. {connector} ë„ˆê°€ ëˆŒëŸ¬ì„œ.",

    // í•™êµ
    "{schoolThing} í•˜ë‹¤ê°€ {agent} ìƒê°ë‚˜ë©´ ì§„ì§œ ëì´ë‹¤.",
    "êµì‹¤ì—ì„œ {subject}ë¥¼ ë³´ìë§ˆì ë“  ìƒê°: '{agent}â€¦'",
    "{connector} ìˆ˜í–‰í‰ê°€ë³´ë‹¤ {agent}ê°€ ë” ë¬´ì„­ë‹¤.",

    // ê¸°ìˆ 
    "{techThing} í„°ì¡ŒëŠ”ë°ë„ {opener} í•˜ëŠ” ë‚´ê°€ ë” ë¬´ì„­ë‹¤.",
    "í•´ê²°ì±…: {techThing} ì¬ì‹œì‘.\në¶€ì‘ìš©: {agent} ë“±ì¥.",
    "{connector} ìºì‹œëŠ” ì§€ì›Œë„ {agent}ëŠ” ì•ˆ ì§€ì›Œì§„ë‹¤.",

    // ê²Œì„
    "{connector} {gameThing} ë•Œë¬¸ì— {emotion}ì´ í„°ì¡Œë‹¤. {agent}ëŠ” ì›ƒê³  ìˆì—ˆë‹¤.",
    "ì˜¤ëŠ˜ì˜ íŒ¨ì¹˜ë…¸íŠ¸: {gameThing} í•˜í–¥.\n{agent} ìƒí–¥.",
    "ì—°íŒ¨ ì¤‘ì¸ë° {subject}ê°€ ìœ„ë¡œí–ˆë‹¤. 'ê·¸ë˜ë„ {opener}.'",

    // ë„ì‹œ/ìš°ì£¼
    "{cityThing} ì§€ë‚˜ê°€ë‹¤ê°€ {agent}ë¥¼ ë´¤ë‹¤.\nê·¸ê±´ ë‚´ ëˆˆì˜ {tech}ì˜€ë‹¤.",
    "{cosmosThing} ê°™ì€ ì†Œë¦¬ í•˜ì§€ ë§ˆ.\nê·¼ë° ì™œ ë§ëŠ” ë§ ê°™ì§€?",
    "{connector} ìš°ì£¼ê°€ ë„“ì€ ê²Œ ì•„ë‹ˆë¼ ë‚´ {emotion}ì´ ë„“ì€ ê±°ë‹¤.",

    // ê°ì •/ìê¸°ê³ ë°±
    "{connector} ë‚œ ê´œì°®ì€ ì²™ì„ {action}. {agent}ëŠ” ê·¸ê±¸ ì•Œê³  ìˆì—ˆë‹¤.",
    "{opener}. ì‚¬ì‹¤ {emotion}ì´ ê³„ì† ë‚¨ì•„.",
    "ë§ì„ ì¤„ì´ë©´ ë§ˆìŒì´ ëŠ˜ì–´ë‚œë‹¤.\n{connector} ê·¸ë˜ì„œ {agent}ë¥¼ í‚¤ì› ë‹¤.",

    // ì¥ë¬¸/ì‹œ ê°™ì€ ê²ƒ
    "{time}\n{subject} ìœ„ì— {agent}\nê·¸ë¦¬ê³  {person}\n{connector} ë‚˜ëŠ” {opener}.",
    "ê·œì¹™ 1: {subject}ë¥¼ ì˜ì‹¬í•´.\nê·œì¹™ 2: {agent}ë¥¼ ê³¼ì‹ í•˜ì§€ ë§ˆ.\nê·œì¹™ 3: ê·¸ë˜ë„ {opener}.",
    "{connector} ì´ê±´ ì˜ˆì–¸ì´ ì•„ë‹ˆë‹¤.\nê·¸ëƒ¥ {agent}ê°€ ë‚¨ê¸´ ë¡œê·¸ë‹¤.",

    // ëœë¤ êµ¬ì¡°
    "{subject} â†’ {agent} â†’ {techThing}\nê²°ë¡ : {opener}.",
    "ê°€ë”ì€ {agent}ê°€ ì•„ë‹ˆë¼ {person}ì´ ë¬¸ì œë‹¤.\n{connector} ê·¼ë° ë‘˜ ë‹¤ ë‚˜ë‹¤.",
    "{connector} ë„ˆê°€ ì´ê±¸ ì½ëŠ” ìˆœê°„, {agent}ëŠ” ì´ë¯¸ ì„±ê³µí–ˆë‹¤."
  ];

  // íŒ¨í„´ ë³´ì¡° í† í° (ì£¼ì œë³„ë¡œ ë” ë½‘í ìˆ˜ ìˆê²Œ)
  function token(topic){
    const tw = TOPIC_WORDS[topic] || TOPIC_WORDS.META;

    return {
      opener: pick(LEX.opener),
      connector: pick(LEX.connector),
      time: pick(LEX.time),
      subject: pick(LEX.subject),
      person: pick(LEX.person),
      agent: weightedPick([
        { value: pick(tw.agent), weight: 3.2 },
        { value: pick(LEX.creature), weight: 1.0 },
        { value: pick(LEX.magic), weight: 1.1 }
      ]),
      action: pick(LEX.action),
      emotion: pick(LEX.emotion),
      tech: pick(LEX.tech),
      meta: pick(LEX.meta),
      dreamOrReal: pick(["ê¿ˆ","í˜„ì‹¤","í™˜ê°","ê¸°ì–µ","ë²„ê·¸","ê¸°ë¶„","ì—°ì¶œ"]),
      schoolThing: pick(LEX.school),
      techThing: pick(LEX.tech),
      gameThing: pick(LEX.game),
      cityThing: pick(LEX.city),
      cosmosThing: pick(LEX.cosmos),
    };
  }

  // ---------------------------
  // ì”¨ë“œ ë¬¸ì¥ í’€(ì´ˆê¸° + ì£¼ì œë³„)
  // ---------------------------
  const seedLines = [
    "ë‹¹ê·¼ ì‘ ì•…ë§ˆ? ì‘ ë§ˆë²• ì§€ë ì´.",
    "ì‘â€¦ ì–´â€¦ ì–´â€¦.(ìƒê° ë¡œë”©ì¤‘)",
    "ì•…ë§ˆê°€ ë§í–ˆë‹¤: 'ì‘.' ê·¸ë¦¬ê³  ê·¸ê²Œ ëì´ì—ˆë‹¤.",
    "ë§ˆë²•ì€ ìˆì—ˆëŠ”ë°, ì‚¬ìš©ë²•ì´ ì—†ì—ˆë‹¤.",
    "ì§€ë ì´ëŠ” í™ì„ ë¨¹ê³ ë„ ë©€ì©¡í–ˆë‹¤. ë‚˜ëŠ” ë§ì„ ë¨¹ê³  ë¬´ë„ˆì§„ë‹¤.",
    "ì˜¤ëŠ˜ë„ ì„¸ê³„ëŠ” ì •ìƒì´ê³ , ë‚˜ë§Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨.",
    "ì„¤ëª…í•˜ë ¤ê³  í•˜ë©´ ë” í‹€ì–´ì§„ë‹¤. ê·¸ë˜ì„œ {opener}.",
    "ì´ê±´ ë¶„ëª… ë§ì´ ì•ˆ ë˜ëŠ”ë°, ê¸°ë¶„ì€ ë§ë‹¤."
  ];

  const topicSeed = {
    DEVIL: [
      "ì•…ë§ˆëŠ” ì¹œì ˆí–ˆë‹¤. ê·¸ë˜ì„œ ë” ì˜ì‹¬ìŠ¤ëŸ¬ì› ë‹¤.",
      "ê²€ì€ ë†ë‹´ì´ ì•„ë‹ˆë¼ ê²€ì€ ì§„ì‹¤ì´ì—ˆë‹¤.",
      "ì‹¬ì—°ì„ ë´¤ë”ë‹ˆ ì‹¬ì—°ì´ ë¡œê·¸ì¸í–ˆë‹¤."
    ],
    MAGIC: [
      "ì£¼ë¬¸ì„ ì™¸ì› ëŠ”ë° ë‚´ ì´ë¦„ì´ ë‚˜ì™”ë‹¤.",
      "í¬íƒˆì€ ì—´ë ¸ëŠ”ë° ëª©ì ì§€ê°€ ë‚˜ì˜€ë‹¤.",
      "ê¸°ì ì´ ì¼ì–´ë‚¬ëŠ”ë°, ë²„ê·¸ë¡œ ì²˜ë¦¬ëë‹¤."
    ],
    WORM: [
      "ì§€ë ì´ëŠ” ì¡°ìš©íˆ ì¼í•œë‹¤. ê·¸ë˜ì„œ ë¬´ì„­ë‹¤.",
      "í™ì€ ë‹¤ ì•Œê³  ìˆë‹¤. ë§ë§Œ ì•ˆ í•  ë¿.",
      "ë°”ë‹¥ì€ ëŠ˜ ì •ì§í•˜ë‹¤. ë‚œ ëŠ˜ ë¯¸ë„ëŸ½ë‹¤."
    ],
    TECH: [
      "ë²„ê·¸ë¥¼ ì¡ì•˜ë”ë‹ˆ ìƒˆ ë²„ê·¸ê°€ ìƒì†ëë‹¤.",
      "ìºì‹œë¥¼ ì§€ìš°ë©´ ë§ˆìŒë„ ì§€ì›Œì§€ë©´ ì¢‹ê² ë‹¤.",
      "ì¬ì‹œì‘ì€ í•´ê²°ì±…ì´ ì•„ë‹ˆë¼ ê¸°ë„ë‹¤."
    ],
    GAME: [
      "ë©˜íƒˆì´ ë¨¼ì € ì£½ê³ , ê·¸ ë‹¤ìŒì— ê²Œì„ì´ ì£½ëŠ”ë‹¤.",
      "ì—°íŒ¨ëŠ” ìˆ«ìê°€ ì•„ë‹ˆë¼ ë¶„ìœ„ê¸°ë‹¤.",
      "ìºë¦¬ëŠ” ì‹¤ë ¥ì´ê³ , ì—°íŒ¨ëŠ” ìš´ëª…ì´ë‹¤."
    ],
    SCHOOL: [
      "ì¹ íŒì€ ì§„ì‹¤ì„ ì ê³ , ë‚˜ëŠ” ê±°ì§“ë§ì²˜ëŸ¼ ì¡¸ì•˜ë‹¤.",
      "ìˆ™ì œëŠ” ë¯¸ë£°ìˆ˜ë¡ ë¬´ê±°ì›Œì§„ë‹¤.",
      "ìˆ˜í–‰í‰ê°€ëŠ” ë‚´ ì •ì‹ ë ¥ í…ŒìŠ¤íŠ¸ë‹¤."
    ],
    META: [
      "ì´ ë¬¸ì¥ì€ ë„ˆì˜ í´ë¦­ìœ¼ë¡œ ì‚´ì•„ë‚¨ëŠ”ë‹¤.",
      "íŒ¨í„´ì€ ë°˜ë³µì´ ì•„ë‹ˆë¼ ê¸°ì–µì´ë‹¤.",
      "ë¡œì»¬ ì €ì¥ì´ë€, í›„íšŒë¥¼ ì§€ìš°ì§€ ëª»í•œë‹¤ëŠ” ëœ»."
    ],
    NIGHT: [
      "ìƒˆë²½ì€ ë³€ëª…ì„ ì˜ ë“¤ì–´ì¤€ë‹¤.",
      "ì ì´ ì˜¤ë©´ ì¢‹ê² ëŠ”ë°, ìƒê°ì´ ë” ê¹¨ì–´ìˆë‹¤.",
      "ê°€ë¡œë“±ì´ ë‚´ ê¸°ë¶„ì„ ëŒ€ì‹  ì¼œì¤€ë‹¤."
    ],
    FRIEND: [
      "ì½ì”¹ì€ ëŒ€ë‹µë³´ë‹¤ ë§ì€ ê±¸ ë§í•œë‹¤.",
      "ì´ëª¨ì§€ í•˜ë‚˜ë¡œ ê°ì •ì´ ì „ì†¡ëœë‹¤(ê°€ë” ì˜¤ë°°ì†¡).",
      "ì¹œêµ¬ëŠ” ê°€ê¹Œìš´ë°, ë§ì€ ë©€ë‹¤."
    ],
    FEEL: [
      "ê´œì°®ì€ ì²™ì´ ì œì¼ í”¼ê³¤í•˜ë‹¤.",
      "ì›ƒê³  ìˆëŠ”ë° ì†ì€ ì¡°ìš©í•˜ì§€ ì•Šë‹¤.",
      "ê°ì •ì€ ì €ì¥ë˜ëŠ”ë°, ì„¤ëª…ì€ ì‹¤íŒ¨í•œë‹¤."
    ],
    COSMOS: [
      "ìš°ì£¼ê°€ ë„“ì–´ì„œ ì™¸ë¡œìš´ ê²Œ ì•„ë‹ˆë‹¤.",
      "í™•ë¥ ì´ë€ ì´ë¦„ìœ¼ë¡œ ìš´ëª…ì´ ë“¤ì–´ì˜¨ë‹¤.",
      "ì‹ í˜¸ê°€ ì•ˆ ì¡íˆëŠ” ê²Œ ì•„ë‹ˆë¼ ë‚´ê°€ ì•ˆ ë³´ë‚´ëŠ” ê±°ë‹¤."
    ],
    CITY: [
      "ë„ì‹œëŠ” ë°ê³ , ì‚¬ëŒì€ ì–´ë‘¡ê³ , ë‚˜ëŠ” ì¤‘ê°„ì´ë‹¤.",
      "ë„¤ì˜¨ì€ ì˜ˆì˜ê³ , ì†ŒìŒì€ ì†”ì§í•˜ë‹¤.",
      "ë¹„ê°€ ì˜¤ë©´ ìƒê°ì´ ë” ì˜ ë“¤ë¦°ë‹¤."
    ]
  };

  // ---------------------------
  // ìƒíƒœ: í•™ìŠµ/ì €ì¥
  // ---------------------------
  let clicks = load(KEY.clicks, 0);
  let userLines = load(KEY.lines, []);
  let mixTopics = load(KEY.mix, true); // ìˆ˜ë™ ì£¼ì œì—ì„œë„ ì¼ë¶€ ì„ê¸°

  // core bias (ì•…ë§ˆ/ë§ˆë²•/ì§€ë ì´ ì¶•)
  const bias = load(KEY.bias, { devil: 1, magic: 1, worm: 1 });

  // topic bias (12ê°œ)
  const topicBias = load(KEY.topicBias, Object.fromEntries(Object.keys(TOPICS).map(k=>[k,1])));

  // í˜„ì¬ ì£¼ì œ
  let currentTopic = load(KEY.topic, "AUTO");

  // ---------------------------
  // DOM
  // ---------------------------
  const el = {
    sentence: document.getElementById("sentence"),
    topicChip: document.getElementById("topicChip"),
    moodChip: document.getElementById("moodChip"),
    countChip: document.getElementById("countChip"),
    seedInfo: document.getElementById("seedInfo"),
    topicSelect: document.getElementById("topicSelect"),

    barDevil: document.getElementById("barDevil"),
    barMagic: document.getElementById("barMagic"),
    barWorm: document.getElementById("barWorm"),
    pctDevil: document.getElementById("pctDevil"),
    pctMagic: document.getElementById("pctMagic"),
    pctWorm: document.getElementById("pctWorm"),
  };

  // ì£¼ì œ ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
  (function fillTopics(){
    const keys = Object.keys(TOPICS);
    for(const k of keys){
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = TOPICS[k];
      el.topicSelect.appendChild(opt);
    }
  })();

  // ---------------------------
  // HUD
  // ---------------------------
  function normalizeCoreBias(){
    const total = bias.devil + bias.magic + bias.worm;
    return {
      devil: bias.devil/total,
      magic: bias.magic/total,
      worm: bias.worm/total
    };
  }
  function moodFromCore(n){
    const entries = Object.entries(n).sort((a,b)=>b[1]-a[1]);
    const top = entries[0][0];
    const pct = Math.round(entries[0][1]*100);
    if(top==="devil") return `MOOD: ì•…ë§ˆ ${pct}% ğŸ˜ˆ`;
    if(top==="magic") return `MOOD: ë§ˆë²• ${pct}% ğŸª„`;
    return `MOOD: ì§€ë ì´ ${pct}% ğŸª±`;
  }

  function updateHUD(){
    const n = normalizeCoreBias();
    el.moodChip.textContent = moodFromCore(n);
    el.countChip.textContent = "#" + String(clicks).padStart(3,"0");

    const d = Math.round(n.devil*100);
    const m = Math.round(n.magic*100);
    const w = 100 - d - m;

    el.barDevil.style.width = d + "%";
    el.barMagic.style.width = m + "%";
    el.barWorm.style.width = w + "%";
    el.pctDevil.textContent = d + "%";
    el.pctMagic.textContent = m + "%";
    el.pctWorm.textContent = w + "%";

    const topicName = currentTopic==="AUTO" ? "AUTO" : TOPICS[currentTopic];
    el.topicChip.textContent = "TOPIC: " + topicName;

    el.seedInfo.textContent =
      `bias(core): ì•…ë§ˆÃ—${bias.devil.toFixed(1)} / ë§ˆë²•Ã—${bias.magic.toFixed(1)} / ì§€ë ì´Ã—${bias.worm.toFixed(1)} Â· ` +
      `topic-mix: ${mixTopics ? "ON" : "OFF"}`;

    el.topicSelect.value = currentTopic;
  }

  // ---------------------------
  // í•™ìŠµ(ì£¼ì œ + core)
  // ---------------------------
  function learnCoreFromText(text, amt){
    const t = String(text);
    if(t.includes("ì•…ë§ˆ") || t.includes("ê·¸ë¦¼ì") || t.includes("ì‹¬ì—°")) bias.devil += amt;
    if(t.includes("ë§ˆë²•") || t.includes("ì£¼ë¬¸") || t.includes("ë£¬") || t.includes("í¬íƒˆ")) bias.magic += amt;
    if(t.includes("ì§€ë ì´") || t.includes("í™") || t.includes("ì§„í™") || t.includes("ë°”ë‹¥")) bias.worm += amt;
    save(KEY.bias, bias);
  }

  function learnTopic(topic, amt){
    topicBias[topic] = (topicBias[topic] ?? 1) + amt;
    save(KEY.topicBias, topicBias);
  }

  function autoPickTopic(){
    // topicBias ê¸°ë°˜ ë£°ë ›
    const options = Object.keys(TOPICS).map(k=>({ value:k, weight: topicBias[k] ?? 1 }));
    return weightedPick(options);
  }

  // ---------------------------
  // ì£¼ì œ ì„ê¸°(ìˆ˜ë™ì´ì–´ë„ ì¡°ê¸ˆ ì„ì´ê²Œ)
  // ---------------------------
  function effectiveTopic(){
    if(currentTopic === "AUTO") return autoPickTopic();
    if(!mixTopics) return currentTopic;

    // ìˆ˜ë™ ì£¼ì œë¼ë„ 25% í™•ë¥ ë¡œ ë‹¤ë¥¸ ì£¼ì œ ì„ìŒ(ê³¼í•˜ê²Œ ê³ ì •ë˜ëŠ” ê±° ë°©ì§€)
    if(Math.random() < 0.25) return autoPickTopic();
    return currentTopic;
  }

  // ---------------------------
  // ë¬¸ì¥ ìƒì„±: ë‹¤ì–‘ë„ í•µì‹¬
  // ---------------------------
  function generate(){
    const tpc = effectiveTopic();
    const tw = TOPIC_WORDS[tpc] || TOPIC_WORDS.META;

    // í’€ êµ¬ì„±: ê¸°ë³¸ + ì£¼ì œ ì”¨ë“œ + ìœ ì € ë¬¸ì¥
    const pool = [
      ...seedLines.map(s=>s),
      ...(topicSeed[tpc] || []),
      ...userLines
    ];

    // ì„ íƒ ë¡œì§: í’€/ìƒì„±ê¸°/ì§§ì€ë§/ë©”íƒ€
    const mode = weightedPick([
      { value:"POOL", weight: 32 },
      { value:"GEN",  weight: 58 },
      { value:"SHORT",weight: 10 }
    ]);

    let out = "";

    if(mode === "POOL" && pool.length){
      out = pick(pool);
      // í…œí”Œë¦¿ í† í°ì´ ìˆìœ¼ë©´ í•œë²ˆ í¬ë§·í•´ì£¼ê¸°
      if(out.includes("{opener}")){
        out = format(out, token(tpc));
      }
      learnCoreFromText(out, 0.18);
    }
    else if(mode === "SHORT"){
      const pack = [
        `${pick(LEX.opener)} ${pick(tw.agent)}.`,
        `${pick(LEX.subject)}? ${pick(LEX.opener)}.`,
        `${pick(LEX.opener)}â€¦ ${pick(LEX.emotion)}.`,
        `${pick(LEX.opener)} ${pick(LEX.connector)} ${pick(tw.agent)}.`
      ];
      out = pick(pack);
      learnCoreFromText(out, 0.22);
    }
    else {
      // ìƒì„±ê¸°
      const map = token(tpc);

      // core biasë¥¼ agent ì„ íƒì— ì„ì–´ì„œ í¸í–¥ ê°•í™”
      const agentCore = weightedPick([
        { value:"ì•…ë§ˆ", weight: bias.devil },
        { value:"ë§ˆë²•", weight: bias.magic },
        { value:"ì§€ë ì´", weight: bias.worm }
      ]);

      // ì£¼ì œ agentë¥¼ ìš°ì„ ìœ¼ë¡œ í•˜ë˜ core ë‹¨ì–´ê°€ ê°€ë” ê°•ì œ ë“±ì¥
      if(Math.random() < 0.32){
        map.agent = pick(TOPIC_WORDS[
          agentCore === "ì•…ë§ˆ" ? "DEVIL" :
          agentCore === "ë§ˆë²•" ? "MAGIC" : "WORM"
        ].agent);
      }

      out = format(pick(PAT), map)
        .replace(/\s{2,}/g, " ")
        .trim();

      // í•™ìŠµ: ì£¼ì œ + ì½”ì–´
      learnCoreFromText(out, 0.26);
    }

    // ì£¼ì œ í•™ìŠµ
    learnTopic(tpc, 0.22);

    // í˜„ì¬ ë³´ì—¬ì£¼ëŠ” ì£¼ì œ ì¹©ì€ AUTOë©´ "AUTO"ë¡œ ìœ ì§€, ìˆ˜ë™ì´ë©´ ê·¸ëŒ€ë¡œ
    return { text: out, usedTopic: tpc, tag: tw.moodTag };
  }

  // ---------------------------
  // ë‹¤ìŒ ë¬¸ì¥
  // ---------------------------
  function next(){
    const g = generate();
    clicks++;
    save(KEY.clicks, clicks);

    el.sentence.classList.remove("show");
    setTimeout(()=>{
      el.sentence.textContent = g.text;
      el.sentence.classList.add("show");
      updateHUD();
      spawnFloat(); // bias ë°˜ì˜í•´ì„œ ë°°ê²½ë„ ê°±ì‹ 
    }, 150);
  }

  // ---------------------------
  // ë³µì‚¬ / ì¶”ê°€ / ë¦¬ì…‹
  // ---------------------------
  function copyCurrent(){
    const t = el.sentence.textContent.trim();
    if(!t) return;
    navigator.clipboard?.writeText(t).then(()=> toast("ë³µì‚¬ë¨"), ()=> fallbackCopy(t));
  }
  function fallbackCopy(text){
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand("copy"); toast("ë³µì‚¬ë¨"); }
    catch{ toast("ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ)"); }
    ta.remove();
  }

  function addLine(){
    const input = prompt("ì¶”ê°€í•  ë¬¸ì¥ ì…ë ¥ (ê¸¸ì–´ë„ ë¨ / ì´ìƒí• ìˆ˜ë¡ í™˜ì˜):");
    if(!input) return;
    const line = input.trim();
    if(!line) return;

    userLines.unshift(line);
    userLines = [...new Set(userLines)].slice(0, 400);
    save(KEY.lines, userLines);

    learnCoreFromText(line, 0.45); // ì¶”ê°€ ë¬¸ì¥ì€ í•™ìŠµ ê°•í•˜ê²Œ
    toast("ë¬¸ì¥ ì¶”ê°€ ì™„ë£Œ");
    next();
  }

  function resetAll(){
    if(!confirm("ì§„ì§œ ë¦¬ì…‹? (ì¶”ê°€ ë¬¸ì¥/í´ë¦­/ë°”ì´ì–´ìŠ¤/ì£¼ì œ í•™ìŠµ ì „ë¶€ ì´ˆê¸°í™”)")) return;
    localStorage.removeItem(KEY.lines);
    localStorage.removeItem(KEY.clicks);
    localStorage.removeItem(KEY.bias);
    localStorage.removeItem(KEY.topicBias);
    localStorage.removeItem(KEY.topic);
    localStorage.removeItem(KEY.mix);

    userLines = [];
    clicks = 0;
    bias.devil = 1; bias.magic = 1; bias.worm = 1;
    for(const k of Object.keys(TOPICS)) topicBias[k] = 1;
    currentTopic = "AUTO";
    mixTopics = true;

    toast("ì´ˆê¸°í™”ë¨");
    updateHUD();
    spawnFloat();
    next();
  }

  // ---------------------------
  // ë°°ê²½ ë– ë‹¤ë‹ˆëŠ” ë‹¨ì–´(ì£¼ì œ/ì½”ì–´ bias ë°˜ì˜)
  // ---------------------------
  function spawnFloat(){
    const host = document.getElementById("float");
    host.innerHTML = "";

    // core ê¸°ë°˜ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ì„ íƒ
    const coreN = normalizeCoreBias();

    function pickWord(){
      const cat = weightedPick([
        { value:"devil", weight: coreN.devil },
        { value:"magic", weight: coreN.magic },
        { value:"worm",  weight: coreN.worm }
      ]);
      if(cat==="devil") return pick(["ì•…ë§ˆ","ê·¸ë¦¼ì","ì‹¬ì—°","ìœ í˜¹","ê²€ì€ë§","ë§ë ¹"]);
      if(cat==="magic") return pick(["ë§ˆë²•","ì£¼ë¬¸","ë£¬","í¬íƒˆ","ê²°ê³„","ê¸°ì "]);
      return pick(["ì§€ë ì´","í™","ë°”ë‹¥","ì§„í™","ë¨¼ì§€","ë•…ì†"]);
    }

    const N = 20;
    for(let i=0;i<N;i++){
      const s = document.createElement("span");
      s.textContent = pickWord();
      const dur = 18 + Math.random()*18;

      s.style.left = (Math.random()*100) + "vw";
      s.style.top  = (Math.random()*100) + "vh";
      s.style.animationDuration = dur + "s";
      s.style.setProperty("--x0", (Math.random()*120-10) + "vw");
      s.style.setProperty("--y0", (Math.random()*120-10) + "vh");
      s.style.setProperty("--x1", (Math.random()*120-10) + "vw");
      s.style.setProperty("--y1", (Math.random()*120-10) + "vh");
      s.style.opacity = (0.25 + Math.random()*0.35).toFixed(2);
      host.appendChild(s);
    }
  }

  // ---------------------------
  // ì£¼ì œ ì»¨íŠ¸ë¡¤
  // ---------------------------
  function setTopic(t){
    currentTopic = t;
    save(KEY.topic, currentTopic);
    toast(currentTopic==="AUTO" ? "ì£¼ì œ: AUTO" : `ì£¼ì œ: ${TOPICS[currentTopic]}`);
    updateHUD();
    next();
  }

  document.getElementById("btnAuto").addEventListener("click", ()=> setTopic("AUTO"));
  document.getElementById("btnShuffle").addEventListener("click", ()=>{
    mixTopics = !mixTopics;
    save(KEY.mix, mixTopics);
    toast("ì£¼ì œ ì„ê¸°: " + (mixTopics ? "ON" : "OFF"));
    updateHUD();
  });

  el.topicSelect.addEventListener("change", (e)=> setTopic(e.target.value));

  // ---------------------------
  // ë²„íŠ¼/í‚¤
  // ---------------------------
  document.getElementById("btnNext").addEventListener("click", next);
  document.getElementById("btnCopy").addEventListener("click", copyCurrent);
  document.getElementById("btnAdd").addEventListener("click", addLine);
  document.getElementById("btnReset").addEventListener("click", resetAll);
  document.getElementById("sentence").addEventListener("click", next);

  window.addEventListener("keydown", (e)=>{
    const k = e.key.toLowerCase();
    if(e.key === " " || e.key === "Enter"){ e.preventDefault(); next(); }
    if(k==="c") copyCurrent();
    if(k==="a") addLine();
    if(k==="r") resetAll();
    if(k==="t"){ setTopic("AUTO"); }
  });

  // ---------------------------
  // ì‹œì‘
  // ---------------------------
  updateHUD();
  spawnFloat();
  next();
  setInterval(spawnFloat, 20000);
</script>
</body>
</html>
